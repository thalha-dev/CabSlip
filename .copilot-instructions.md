# CabSlip Android App - Copilot Instructions

## Project Overview
CabSlip is a native Android application built for cab/taxi drivers to generate digital receipts for their trips. The app features centralized signature management and comprehensive data backup/restore capabilities for seamless device transfers.

## Tech Stack & Architecture
- **Language**: Kotlin
- **UI Framework**: Jetpack Compose (Material 3)
- **Architecture**: MVVM with Repository pattern
- **Database**: Room (SQLite)
- **Navigation**: Jetpack Navigation Compose
- **PDF Generation**: Custom PDF generation utility
- **Serialization**: Kotlin Serialization for backup/restore
- **Minimum SDK**: 29 (Android 10)
- **Target SDK**: 36
- **Compile SDK**: 36

## Project Structure
```
app/src/main/java/dev/thalha/cabslip/
├── MainActivity.kt                          # Entry point
├── data/
│   ├── database/CabSlipDatabase.kt         # Room database setup
│   ├── dao/                                # Data Access Objects
│   ├── entity/                             # Database entities (CabInfo, Receipt)
│   ├── model/                              # Data models (BackupData)
│   └── repository/CabSlipRepository.kt     # Data repository layer
├── ui/
│   ├── components/                         # Reusable UI components
│   │   ├── SignatureCapture.kt            # Digital signature component
│   │   └── LogoUpload.kt                  # Logo upload component
│   ├── navigation/CabSlipNavigation.kt    # Navigation setup with settings
│   ├── screens/                           # All app screens
│   │   ├── FirstTimeSetupScreen.kt        # Onboarding with signature
│   │   ├── HomeScreen.kt                  # Dashboard
│   │   ├── CabInfoScreen.kt               # Business info + signature management
│   │   ├── CreateReceiptScreen.kt         # New receipt creation (no signature)
│   │   ├── EditReceiptScreen.kt           # Receipt editing (no signature)
│   │   ├── ReceiptsScreen.kt              # Receipt listing
│   │   └── SettingsScreen.kt              # Data backup/restore settings
│   └── theme/                             # Material 3 theming
└── utils/                                 # Utility classes
    ├── PdfGenerator.kt                    # PDF creation with centralized signature
    ├── ShareUtils.kt                      # Sharing functionality
    ├── BackupRestoreUtils.kt              # Backup/restore functionality
    └── ReceiptIdGenerator.kt              # Unique ID generation
```

## Core Features

### 1. Centralized Signature Management
- **Business Profile Signature**: Owner signature stored once in CabInfo entity
- **Automatic Application**: Signature automatically included in all receipt PDFs
- **Setup Integration**: Signature capture included in FirstTimeSetupScreen
- **CabInfo Management**: Signature editable in CabInfoScreen
- **No Per-Receipt Signatures**: Simplified workflow without individual receipt signatures

### 2. Data Backup & Restore System
- **Complete Export**: Export all receipts and business info to JSON file
- **Device Transfer**: Easy migration when getting new devices
- **Settings Integration**: Backup/restore accessible from dedicated settings screen
- **Simplified Structure**: No signature file handling - all data in JSON format
- **Confirmation Dialogs**: Safe import with user confirmation for data replacement

### 3. Enhanced Navigation
- **Settings Tab**: Dedicated settings section in bottom navigation
- **Settings Screen**: Centralized data management interface
- **Home Settings Icon**: Quick access to settings from dashboard
- **Clean Structure**: Organized navigation with proper separation of concerns

### 4. Receipt Management (Updated)
- **Create Receipt**: Streamlined creation without signature handling
- **Edit Receipt**: Full editing capabilities without signature management
- **List Receipts**: View all created receipts with search/filter
- **Delete Receipts**: Delete with confirmation dialog
- **PDF Generation**: Automatic signature inclusion from business profile

### 5. Trip Details Capture
- **Locations**: Boarding location and destination
- **Date/Time**: Trip start/end with date/time pickers
- **Fare Calculation**: 
  - Base fare (Price per KM × Total KM)
  - Waiting charges (Rate per hour × Hours)
  - Additional charges (Toll, Parking, Bata)
  - Auto-calculated totals
- **Driver Details**: Name, mobile, vehicle number

### 6. PDF Generation & Sharing (Updated)
- **Professional PDFs**: Generate formatted receipt PDFs
- **Centralized Signature**: Owner signature from CabInfo automatically included
- **Share Functionality**: Share PDFs via various apps
- **Receipt ID**: Auto-generated unique receipt IDs

## Database Schema (Updated)

### CabInfo Entity
- `id`: Primary key (always 1 for single row)
- `cabName`: Cab company name
- `cabAddress`: Business address
- `primaryContact`: Primary phone number
- `secondaryContact`: Secondary phone number (optional)
- `email`: Business email
- `logoPath`: Company logo file path (optional)
- `ownerSignaturePath`: Owner signature file path (NEW - centralized signature)
- `createdAt`, `updatedAt`: Timestamps

### Receipt Entity (Updated - No Signature)
- `receiptId`: Unique receipt identifier (Primary key)
- `boardingLocation`, `destination`: Trip locations
- `tripStartDate`, `tripEndDate`: Trip timestamps
- `pricePerKm`, `totalKm`: Fare calculation base
- `waitingChargePerHr`, `waitingHrs`: Waiting charges
- `tollParking`, `bata`: Additional charges
- `driverName`, `driverMobile`, `vehicleNumber`: Driver details
- `baseFare`, `waitingFee`, `totalFee`: Calculated amounts
- `createdAt`, `updatedAt`: Timestamps
- **REMOVED**: `ownerSignaturePath` (moved to CabInfo)

### BackupData Model (NEW)
- `version`: Backup format version
- `timestamp`: Backup creation time
- `cabInfo`: Complete CabInfo entity
- `receipts`: List of all Receipt entities

## Key UI Components

### SignatureCapture (Updated)
- Canvas-based signature drawing
- Save/clear functionality
- File system storage
- Used in FirstTimeSetupScreen and CabInfoScreen
- No longer used in receipt creation/editing screens

### SettingsScreen (NEW)
- Data export/import interface
- File picker integration for backup files
- Confirmation dialogs for destructive operations
- Progress indicators for backup/restore operations
- User-friendly error handling and success messages

### FirstTimeSetupScreen (Updated)
- Includes signature capture as part of initial setup
- Comprehensive onboarding experience
- Ensures signature is captured during first use

### Navigation Structure (Updated)
- Bottom navigation: Home, Create, Receipts, CabInfo, Settings
- Settings icon on HomeScreen for quick access
- Screen navigation with proper state management
- Back navigation handling

## Important Implementation Details

### 1. Centralized Signature Architecture
- Signature stored once in CabInfo entity
- PDF generation reads signature from CabInfo, not Receipt
- Simplified receipt creation workflow
- Consistent signature across all receipts
- No signature file duplication

### 2. Backup/Restore System
- Kotlin Serialization for JSON handling
- Complete data export including business profile
- Safe import with data replacement warnings
- No complex file handling - pure JSON approach
- Error handling with user-friendly messages

### 3. Database Management
- Room database with proper migration handling
- Fallback to destructive migration for development
- Clean schema without signature field in receipts
- Proper entity relationships and constraints

### 4. Material 3 Usage
- Using stable Material 3 APIs
- Some experimental APIs may require `@OptIn(ExperimentalMaterial3Api::class)`
- Proper color schemes and theming
- Consistent design patterns across screens

### 5. File Storage
- Signatures stored in app's private storage (centralized)
- Logo images handled through file picker
- Proper file path management
- Backup files use Android's document picker

## Recent Major Changes

### 1. Signature Architecture Refactor
- **Moved** signature from Receipt entity to CabInfo entity
- **Updated** PDF generation to use centralized signature
- **Simplified** receipt creation/editing workflows
- **Enhanced** FirstTimeSetupScreen with signature capture
- **Removed** signature handling from CreateReceiptScreen and EditReceiptScreen

### 2. Backup & Restore Implementation
- **Added** SettingsScreen with data management
- **Implemented** BackupRestoreUtils for JSON serialization
- **Created** BackupData model for structured exports
- **Integrated** file picker for import/export operations
- **Added** comprehensive error handling and user feedback

### 3. Navigation Enhancements
- **Added** Settings tab to bottom navigation
- **Implemented** settings icon on HomeScreen
- **Organized** settings-related functionality
- **Improved** navigation structure and user flow

### 4. Database Schema Updates
- **Added** ownerSignaturePath to CabInfo
- **Removed** ownerSignaturePath from Receipt
- **Implemented** proper database migration handling
- **Added** fallback strategy for development

## Development Guidelines

### Code Style
- Follow Kotlin conventions
- Use Jetpack Compose best practices
- Implement proper state management
- Add comprehensive error handling
- Use Kotlin Serialization for data structures

### UI/UX Patterns
- Material 3 design system
- Consistent spacing and typography
- Loading states for all async operations
- Confirmation dialogs for destructive actions
- Clear user feedback for backup/restore operations

### Testing Considerations
- Room database testing with migrations
- Repository layer testing
- UI component testing with Compose
- PDF generation validation
- Backup/restore functionality testing

### Performance Considerations
- Efficient database queries
- Proper image handling and compression
- Memory management for signatures
- Lazy loading for receipt lists
- JSON serialization optimization

## Common Issues & Solutions

### 1. Database Migration Issues
- Use fallbackToDestructiveMigration() for development
- Proper version management for production releases
- Test migration paths thoroughly

### 2. Signature File Handling
- Centralized storage approach reduces complexity
- Proper file path validation
- Handle signature loading errors gracefully

### 3. Backup/Restore Errors
- Comprehensive error handling for file operations
- User-friendly error messages
- Validation of backup file format and content

### 4. Navigation State Management
- Proper navigation state handling
- Handle back stack correctly
- Ensure proper screen transitions

## Future Enhancement Ideas
- Cloud backup integration
- Data encryption for backup files
- Receipt templates and customization
- Analytics and reporting dashboard
- Multi-user support with individual signatures
- Automated backup scheduling
- Data compression for large backups
- Export to different formats (CSV, Excel)

## Package Information
- **Package Name**: `dev.thalha.cabslip`
- **Version**: 1.0 (versionCode: 1)
- **Database Version**: 1 (with proper schema)
- **Minimum Android Version**: Android 10 (API 29)
- **Target Android Version**: Android 14+ (API 36)

## Key Dependencies Added
- **Kotlin Serialization**: `kotlinx-serialization-json` for backup/restore
- **Serialization Plugin**: `kotlin("plugin.serialization")` for annotation processing

This project represents a complete, production-ready Android application with modern architecture patterns, centralized signature management, and comprehensive data backup/restore functionality for professional cab receipt management.
